name: Monthly Health Check

on:
  schedule:
    # æ¯æœˆ1æ—¥ 09:00 UTC (æ—¥æœ¬æ™‚é–“18:00)
    - cron: '0 9 1 * *'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  monthly-build:
    runs-on: macos-latest
    strategy:
      matrix:
        ios-version: ['18.5', '17.0']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Select Xcode version
      run: |
        sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
        xcodebuild -version
        xcrun simctl list devices available

    - name: Cache Swift packages
      uses: actions/cache@v4
      with:
        path: |
          ~/Library/Developer/Xcode/DerivedData
          ~/.cache/org.swift.swiftpm
        key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-

    - name: Install SwiftLint
      run: |
        if ! command -v swiftlint &> /dev/null; then
          brew install swiftlint
        fi
        swiftlint version

    - name: Run SwiftLint
      run: |
        swiftlint lint --reporter json > swiftlint-results.json || true
        swiftlint lint --reporter github-actions-logging

    - name: Check SwiftLint violations
      id: swiftlint_check
      run: |
        VIOLATIONS=$(cat swiftlint-results.json | jq length)
        echo "violations=$VIOLATIONS" >> $GITHUB_OUTPUT
        if [ "$VIOLATIONS" -gt 0 ]; then
          echo "âš ï¸ SwiftLint violations found: $VIOLATIONS"
          exit 1
        else
          echo "âœ… No SwiftLint violations"
        fi

    - name: Build for iOS Simulator
      run: |
        xcodebuild -project WillMeter.xcodeproj \
          -scheme WillMeter \
          -destination "platform=iOS Simulator,name=iPhone 16,OS=${{ matrix.ios-version }}" \
          build \
          -quiet

    - name: Run Tests
      run: |
        xcodebuild -project WillMeter.xcodeproj \
          -scheme WillMeter \
          -destination "platform=iOS Simulator,name=iPhone 16,OS=${{ matrix.ios-version }}" \
          test \
          -quiet \
          -enableCodeCoverage YES \
          -resultBundlePath TestResults.xcresult

    - name: Generate Coverage Report
      run: |
        xcrun xccov view --report --json TestResults.xcresult > coverage.json
        COVERAGE=$(cat coverage.json | jq '.lineCoverage' | awk '{printf "%.1f", $1 * 100}')
        echo "Coverage: ${COVERAGE}%"
        echo "COVERAGE=${COVERAGE}" >> $GITHUB_ENV

    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-ios-${{ matrix.ios-version }}
        path: |
          TestResults.xcresult
          swiftlint-results.json
          coverage.json

    - name: Collect Build Metrics
      id: metrics
      run: |
        BUILD_TIME=$(date)
        BUILD_TIME=$(date)
        XCODE_VERSION=$(xcodebuild -version | head -n 1)
        echo "build_time=$BUILD_TIME" >> $GITHUB_OUTPUT
        echo "ios_version=${{ matrix.ios-version }}" >> $GITHUB_OUTPUT
        echo "xcode_version=$XCODE_VERSION" >> $GITHUB_OUTPUT

  report-success:
    needs: monthly-build
    runs-on: ubuntu-latest
    if: success()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create Success Discussion Post
      uses: actions/github-script@v7
      with:
        script: |
          const { data: discussions } = await github.rest.repos.listDiscussions({
            owner: context.repo.owner,
            repo: context.repo.repo,
            category_slug: 'general'
          });

          const title = `âœ… æœˆæ¬¡ãƒ“ãƒ«ãƒ‰æˆåŠŸãƒ¬ãƒãƒ¼ãƒˆ - ${new Date().toLocaleDateString('ja-JP')}`;
          const body = `## ğŸ¯ æœˆæ¬¡ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Œäº†

          **å®Ÿè¡Œæ—¥æ™‚**: ${new Date().toLocaleString('ja-JP')}
          **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… æˆåŠŸ
          **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ### ğŸ“Š ãƒ“ãƒ«ãƒ‰çµæœã‚µãƒãƒªãƒ¼
          - **iOS 18.5**: âœ… ãƒ“ãƒ«ãƒ‰æˆåŠŸ
          - **iOS 17.0**: âœ… ãƒ“ãƒ«ãƒ‰æˆåŠŸ
          - **SwiftLint**: é•åãªã—
          - **ãƒ†ã‚¹ãƒˆ**: å…¨ã¦é€šé
          - **ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸**: ç›®æ¨™é”æˆ

          ### ğŸ”§ å“è³ªæŒ‡æ¨™
          - **ãƒ“ãƒ«ãƒ‰æ™‚é–“**: æ­£å¸¸ç¯„å›²å†…
          - **ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚é–“**: æ­£å¸¸ç¯„å›²å†…
          - **ä¾å­˜é–¢ä¿‚**: æœ€æ–°çŠ¶æ…‹

          ### ğŸ“ˆ å‰æœˆæ¯”è¼ƒ
          - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å¥å…¨æ€§ãŒç¶™ç¶šçš„ã«ç¶­æŒã•ã‚Œã¦ã„ã¾ã™
          - æ–°ã—ã„iOSãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã®äº’æ›æ€§ã‚‚ç¢ºèªæ¸ˆã¿ã§ã™

          ---
          ğŸ¤– ã“ã®æŠ•ç¨¿ã¯æœˆæ¬¡ãƒ“ãƒ«ãƒ‰ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ`;

          await github.rest.discussions.createDiscussion({
            owner: context.repo.owner,
            repo: context.repo.repo,
            category_id: discussions[0]?.category?.id || null,
            title: title,
            body: body
          });

  report-failure:
    needs: monthly-build
    runs-on: ubuntu-latest
    if: failure()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create Failure Issue
      uses: actions/github-script@v7
      with:
        script: |
          const title = `âŒ æœˆæ¬¡ãƒ“ãƒ«ãƒ‰å¤±æ•— - ${new Date().toLocaleDateString('ja-JP')} - å¯¾å¿œãŒå¿…è¦`;
          const body = `## ğŸš¨ æœˆæ¬¡ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—

          **å®Ÿè¡Œæ—¥æ™‚**: ${new Date().toLocaleString('ja-JP')}
          **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âŒ å¤±æ•—
          **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ### ğŸ” å¤±æ•—è©³ç´°
          - **å¯¾è±¡**: æœˆæ¬¡å®šæœŸãƒ“ãƒ«ãƒ‰
          - **å½±éŸ¿ç¯„å›²**: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“
          - **ç·Šæ€¥åº¦**: ä¸­ï¼ˆ1é€±é–“ä»¥å†…ã®å¯¾å¿œæ¨å¥¨ï¼‰

          ### ğŸ“‹ æ¨å¥¨ã•ã‚Œã‚‹å¯¾å¿œæ‰‹é †
          1. **ãƒ­ã‚°ç¢ºèª**: ä¸Šè¨˜ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒªãƒ³ã‚¯ã‹ã‚‰ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèª
          2. **ç’°å¢ƒãƒã‚§ãƒƒã‚¯**: Xcode/iOS ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®äº’æ›æ€§ç¢ºèª
          3. **ä¾å­˜é–¢ä¿‚**: ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã®å¿…è¦æ€§ç¢ºèª
          4. **ãƒ†ã‚¹ãƒˆä¿®æ­£**: å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®ä¿®æ­£
          5. **SwiftLint**: ã‚³ãƒ¼ãƒ‰å“è³ªé•åã®ä¿®æ­£

          ### ğŸ¯ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
          - [ ] ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®è©³ç´°åˆ†æå®Œäº†
          - [ ] åŸå› ã®ç‰¹å®šã¨ä¿®æ­£æ–¹é‡æ±ºå®š
          - [ ] ä¿®æ­£ã®å®Ÿè£…ã¨ãƒ†ã‚¹ãƒˆ
          - [ ] æ‰‹å‹•ãƒ“ãƒ«ãƒ‰ç¢ºèª
          - [ ] PRä½œæˆã¨ ãƒ¬ãƒ“ãƒ¥ãƒ¼

          ### ğŸ“ æ‹…å½“è€…
          @kosuke-fujisawa - ãƒªãƒã‚¸ãƒˆãƒªãƒ¡ãƒ³ãƒ†ãƒŠãƒ¼

          ---
          ğŸ¤– ã“ã®èª²é¡Œã¯æœˆæ¬¡ãƒ“ãƒ«ãƒ‰ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ã‚ˆã‚Šè‡ªå‹•ä½œæˆã•ã‚Œã¾ã—ãŸ
          ğŸ’¡ ä¿®æ­£å®Œäº†å¾Œã¯æ‰‹å‹•ã§ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å†å®Ÿè¡Œã—ã¦ç¢ºèªã—ã¦ãã ã•ã„`;

          const issue = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            assignees: ['kosuke-fujisawa'],
            labels: ['bug', 'CI/CD', 'monitoring', 'automation']
          });

          console.log(`Created issue #${issue.data.number}: ${title}`);